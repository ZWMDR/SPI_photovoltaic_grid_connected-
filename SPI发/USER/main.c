#include "led.h"
#include "delay.h"
#include "sys.h"
#include "usart.h"
#include "key.h"
#include "spi.h"
#include "pwm.h"
#include "exti.h"
#include "wave_tracking.h"
#include "adc.h"
#include "caculate.h"

s16 Sin[400]={0,28,56,84,113,141,169,197,225,253,281,309,337,365,392,420,447,474,502,529,556,583,609,636,662,688,714,740,766,791,817,842,867,891,916,940,964,988,1011,1035,1058,1080,1103,1125,1147,1169,1190,1211,1232,1252,1272,1292,1312,1331,1350,1368,1386,1404,1422,1439,1456,1472,1488,1504,1519,1534,1549,1563,1577,1590,1603,1616,1628,1640,1651,1662,1673,1683,1693,1702,1711,1720,1728,1736,1743,1750,1756,1762,1768,1773,1777,1782,1785,1789,1792,1794,1796,1798,1799,1799,1800,1799,1799,1798,1796,1794,1792,1789,1785,1782,1777,1773,1768,1762,1756,1750,1743,1736,1728,1720,1711,1702,1693,1683,1673,1662,1651,1640,1628,1616,1603,1590,1577,1563,1549,1534,1519,1504,1488,1472,1456,1439,1422,1404,1386,1368,1350,1331,1312,1292,1272,1252,1232,1211,1190,1169,1147,1125,1103,1080,1058,1035,1011,988,964,940,916,891,867,842,817,791,766,740,714,688,662,636,609,583,556,529,502,474,447,420,392,365,337,309,281,253,225,197,169,141,113,84,56,28,0,-28,-56,-84,-113,-141,-169,-197,-225,-253,-281,-309,-337,-365,-392,-420,-447,-474,-502,-529,-556,-583,-609,-636,-662,-688,-714,-740,-766,-791,-817,-842,-867,-891,-916,-940,-964,-988,-1011,-1035,-1058,-1080,-1103,-1125,-1147,-1169,-1190,-1211,-1232,-1252,-1272,-1292,-1312,-1331,-1350,-1368,-1386,-1404,-1422,-1439,-1456,-1472,-1488,-1504,-1519,-1534,-1549,-1563,-1577,-1590,-1603,-1616,-1628,-1640,-1651,-1662,-1673,-1683,-1693,-1702,-1711,-1720,-1728,-1736,-1743,-1750,-1756,-1762,-1768,-1773,-1777,-1782,-1785,-1789,-1792,-1794,-1796,-1798,-1799,-1799,-1800,-1799,-1799,-1798,-1796,-1794,-1792,-1789,-1785,-1782,-1777,-1773,-1768,-1762,-1756,-1750,-1743,-1736,-1728,-1720,-1711,-1702,-1693,-1683,-1673,-1662,-1651,-1640,-1628,-1616,-1603,-1590,-1577,-1563,-1549,-1534,-1519,-1504,-1488,-1472,-1456,-1439,-1422,-1404,-1386,-1368,-1350,-1331,-1312,-1292,-1272,-1252,-1232,-1211,-1190,-1169,-1147,-1125,-1103,-1080,-1058,-1035,-1011,-988,-964,-940,-916,-891,-867,-842,-817,-791,-766,-740,-714,-688,-662,-636,-609,-583,-556,-529,-502,-474,-447,-420,-392,-365,-337,-309,-281,-253,-225,-197,-169,-141,-113,-84,-56,-28};

u16 DMA_buff_TX[4];
u16 DMA_buff_RX[4];
u16 DMA_buff[DMA_buff_len_ADC];
u8 flag_REF;
u8 flag_F;
u8 send_flag;
u8 ADC_flag;
u16 Frequency_REF;
u16 Frequency_F;
u16 Period_REF;
u16 Period_F;
u16 t;
float rate;

int main(void)
{
	u16 VCC_REF;
	u16 VCC_F;
	PID vcc_PID;
	
	rate=1;
	delay_init();	    	 //延时函数初始化
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);
	LED_Init();		  		//初始化与LED连接的硬件接口
	PWM_input_Init();
	PWM_init(3600-1,1-1);//20kHz
	ADC1_TIM_Init(_5kHz);
	PID_init(&vcc_PID,0.45,0.1,0.09);
	//SPI1_Init(1000-1,7200-1);
	
	DMA_Cmd(DMA1_Channel1,ENABLE);
	TIM_Cmd(TIM2,ENABLE);
	ADC_Cmd(ADC1,ENABLE);
	
	t=0;
	send_flag=0;
	ADC_flag=0;
	Frequency_REF=Frequency_F=25000;

	while(1)
	{
		if(send_flag)
		{
			TIM6->ARR=(u16)(DMA_buff_TX[0]*0.18)-1;
			send_flag=0;
		}
		if(ADC_flag)
		{
			get_VCC(DMA_buff,DMA_buff_len_ADC,&VCC_REF,&VCC_F);
			rate+=get_iIncpid(&vcc_PID,VCC_REF,VCC_F)*0.00024414;
			if(rate>1)
				rate=1;
			else if(rate<0)
				rate=0;
			DMA_Cmd(DMA1_Channel1,ENABLE);
			TIM_Cmd(TIM2,ENABLE);
			ADC_flag=0;
		}
	}
}

